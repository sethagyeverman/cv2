# CV2 开发者规范文档

## 目录

1. [项目概述](#项目概述)
2. [技术栈](#技术栈)
3. [项目结构](#项目结构)
4. [开发规范](#开发规范)
5. [API 开发流程](#api-开发流程)
6. [数据库规范](#数据库规范)
7. [错误处理规范](#错误处理规范)
8. [代码风格](#代码风格)
9. [常用命令](#常用命令)

---

## 项目概述

CV2 是一个基于 go-zero 框架的简历优化系统，提供简历生成、评分、存储等功能。


---

## 技术栈

### 后端框架

- **go-zero**: 微服务框架
- **Ent**: ORM 框架（MySQL）
- **MongoDB**: 文档数据库
- **Redis**: 缓存和任务状态管理
- **MinIO**: 对象存储

### 工具

- **goctl**: go-zero 代码生成工具
- **make**: 构建工具

---

## 项目结构

```
cv2/
├── api/                    # API 定义文件
│   ├── service.api        # 主 API 文件（导入其他 API）
│   ├── resume.api         # 简历相关 API
│   └── position.api       # 职位相关 API
├── internal/
│   ├── config/            # 配置
│   ├── handler/           # HTTP 处理器（自动生成）
│   ├── logic/             # 业务逻辑
│   ├── middleware/        # 中间件
│   ├── svc/              # 服务上下文
│   ├── types/            # 类型定义（自动生成）
│   ├── infra/            # 基础设施层
│   │   ├── ent/          # Ent ORM
│   │   ├── mongo/        # MongoDB 客户端
│   │   ├── minio/        # MinIO 客户端
│   │   └── algorithm/    # 算法服务客户端
│   └── pkg/              # 公共包
│       ├── errx/         # 错误处理
│       ├── snowflake/    # ID 生成器
│       └── response/     # 响应封装
├── etc/                   # 配置文件
├── docs/                  # 文档
└── Makefile              # 构建脚本
```

---

## 开发规范

### 1. API 开发流程（重要）

**必须遵循的流程**：

1. **定义 API**：在 `api/*.api` 文件中定义接口
2. **生成代码**：运行 `make api` 生成 handler 和 logic
3. **实现逻辑**：在生成的 logic 文件中实现业务逻辑
4. **不要手动创建** handler 和 logic 文件

#### 示例：添加新接口

```api
// api/resume.api
type GenerateResumeReq {
    Questions []QuestionAnswer `json:"questions"`
}

type GenerateResumeResp {
    TaskID string `json:"task_id"`
}

@server (
    group:      resume
    middleware: Auth
)
service cv2 {
    @doc "生成简历"
    @handler GenerateResume
    post /api/resume/generate (GenerateResumeReq) returns (GenerateResumeResp)
}
```

然后运行：

```bash
make api
```

### 2. 多个 API 文件管理

**问题**：直接对单个 API 文件运行 `goctl` 会覆盖 `types.go`，导致其他 API 的类型丢失。

**解决方案**：使用主 API 文件导入所有子 API 文件。

```api
// api/service.api
syntax = "v1"

info (
    title:   "CV2 API"
    desc:    "简历优化系统 API"
    version: "v1.0"
)

import "position.api"
import "resume.api"
```

**Makefile 配置**：

```makefile
.PHONY: api
api:
    goctl api go --api api/service.api --dir . --style goZero
```

### 3. 数据库操作规范

#### Ent Schema 定义

**ID 字段**：使用 Snowflake ID，不使用数据库自增

```go
field.Int64("id").
    Immutable().
    DefaultFunc(snowflake.NextID).
    Comment("简历ID"),
```

**软删除字段**：使用可空的 `deleted_at`

```go
field.Time("deleted_at").
    Optional().
    Nillable().
    Comment("删除时间"),
```

**时间字段**：自动设置创建和更新时间

```go
field.Time("created_at").
    Default(time.Now).
    Immutable().
    Comment("创建时间"),

field.Time("updated_at").
    Default(time.Now).
    UpdateDefault(time.Now).
    Comment("更新时间"),
```

#### 数据库迁移

修改 schema 后运行：

```bash
make generate
```

这会自动：
- 创建新表
- 添加新列
- 添加新索引
- **不会删除现有列和数据**

### 4. 事务处理

**必须使用事务**保证数据一致性：

```go
func (l *Logic) saveData(ctx context.Context, data *Data) error {
    tx, err := l.svcCtx.Ent.Tx(ctx)
    if err != nil {
        return errx.Warp(http.StatusInternalServerError, err, "开启事务失败")
    }
    defer tx.Rollback()

    // 执行多个数据库操作
    _, err = tx.Resume.Create().
        SetID(resumeID).
        // ...
        Save(ctx)
    if err != nil {
        return errx.Warp(http.StatusInternalServerError, err, "创建记录失败")
    }

    // 提交事务
    return tx.Commit()
}
```

---

## 数据库规范

### MySQL（Ent）

**用途**：存储结构化数据、关系数据

- 简历主表（`cv_resume`）
- 评分表（`cv_resume_score`）
- 模块表（`cv_module`）
- 维度表（`cv_dimension`）

### MongoDB

**用途**：存储简历详细内容（灵活的文档结构）

```go
// 保存到 MongoDB
err = l.svcCtx.Mongo.SaveResumeContent(ctx, resumeID, data)
```

**数据结构**：

```json
{
  "mysql_id": 123456789,
  "create_time": "2025-11-25T10:00:00Z",
  "update_time": "2025-11-25T10:00:00Z",
  "raw_md": "# 简历内容...",
  "modules": [
    {
      "module_id": 1,
      "title": "基本信息",
      "data": [{"name": "张三", "phone": "13800138000"}]
    }
  ]
}
```

### Redis

**用途**：缓存、任务状态管理

```go
// 存储任务状态
key := "gen_task:" + taskID
l.svcCtx.Redis.HSet(ctx, key, map[string]any{
    "status":    "PENDING",
    "resume_id": resumeID,
})
l.svcCtx.Redis.Expire(ctx, key, 12*time.Hour)
```

---

## 错误处理规范

### 使用 errx 包

**禁止使用** `fmt.Errorf`，**必须使用** `errx` 包：

```go
// ❌ 错误示例
return fmt.Errorf("保存失败: %w", err)

// ✅ 正确示例
return errx.Warp(http.StatusInternalServerError, err, "保存失败")
```

### errx 方法

```go
// 创建新错误
errx.New(http.StatusBadRequest, "参数错误")

// 格式化错误消息
errx.Newf(http.StatusBadRequest, "参数 %s 错误", paramName)

// 包装错误
errx.Warp(http.StatusInternalServerError, err, "操作失败")

// 包装并格式化
errx.Warpf(http.StatusInternalServerError, err, "保存 %s 失败", name)
```

### HTTP 状态码

- `200` - 成功
- `400` - 客户端错误（参数错误）
- `404` - 资源不存在
- `500` - 服务器错误

---

## 代码风格

### 1. 命名规范

- **文件名**：小驼峰 + 后缀，如 `generateResumeLogic.go`
- **包名**：小写，如 `package resume`
- **结构体**：大驼峰，如 `GenerateResumeLogic`
- **方法**：大驼峰（导出）或小驼峰（私有）
- **常量**：大驼峰或全大写，如 `StatusPending` 或 `STATUS_PENDING`

### 2. 注释规范

```go
// GenerateResume 生成简历
// 根据用户回答的问题，调用算法服务生成简历
func (l *GenerateResumeLogic) GenerateResume(req *types.GenerateResumeReq) (*types.GenerateResumeResp, error) {
    // 1. 转换数据格式
    // 2. 调用算法服务
    // 3. 保存任务状态
}
```

### 3. 日志规范

使用 `logx` 记录日志：

```go
l.Infof("resume generation task created: task_id=%s, resume_id=%d", taskID, resumeID)
l.Errorf("submit generate task failed: %v", err)
```

**日志级别**：
- `Info`: 正常流程信息
- `Error`: 错误信息
- `Debug`: 调试信息（生产环境不输出）

---

## 常用命令

### 开发命令

```bash
# 生成 API 代码（handler、logic、types）
make api

# 生成 Ent 代码（数据库模型）
make generate

# 运行项目
make run

# 编译项目
make build

# 生成 Swagger 文档
make swagger
```

### Git 工作流

```bash
# 创建功能分支
git checkout -b feature/resume-generation

# 提交代码
git add .
git commit -m "feat: 实现简历生成功能"

# 推送到远程
git push origin feature/resume-generation
```

### 提交信息规范

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

---

## 最佳实践

### 1. 简历生成流程

```
用户提交问题 → 构造算法请求 → 提交任务 → 后台监控
    ↓
保存数据（事务）→ 计算评分 → 保存评分（事务）→ 更新状态
```

**关键点**：
- 使用事务保证数据一致性
- 评分完成后才更新 Redis 状态为 SUCCESS
- 后台监控使用 goroutine，避免阻塞主流程

### 2. 算法客户端使用

```go
// 1. 构造请求
req := algorithm.BuildGenerateRequest(qas)

// 2. 提交任务
resp, err := l.svcCtx.Algorithm.SubmitGenerateTask(ctx, req)

// 3. 查询状态
status, err := l.svcCtx.Algorithm.GetTaskStatus(ctx, taskID)

// 4. 评分
scoreResp, err := l.svcCtx.Algorithm.ScoreResume(ctx, &algorithm.ScoreRequest{
    ResumeID: resumeID,
    Data:     data,
})
```

### 3. 配置管理

配置文件：`etc/cv2.yaml`

```yaml
Storages:
  Driver: mysql
  DSN: root:password@tcp(localhost:3306)/cv2

Mongo:
  URI: mongodb://localhost:27017
  Database: cv2

Redis:
  Addr: localhost:6379

Algorithm:
  BaseURL: http://localhost:8000
```

---

## 常见问题

### Q1: 修改 API 后 types.go 被覆盖怎么办？

**A**: 使用主 API 文件（`service.api`）导入所有子 API 文件，然后运行 `make api`。

### Q2: 如何添加新的数据表？

**A**: 
1. 在 `internal/infra/ent/schema/` 创建新的 schema 文件
2. 运行 `make generate` 生成代码
3. 启动项目，Ent 会自动创建表

### Q3: 事务中的错误如何处理？

**A**: 使用 `defer tx.Rollback()`，即使发生错误也会自动回滚。成功时调用 `tx.Commit()`。

### Q4: 如何调试后台 goroutine？

**A**: 使用 `logx` 记录详细日志，查看任务状态变化。

---

## 参考资料

- [go-zero 官方文档](https://go-zero.dev/)
- [Ent 官方文档](https://entgo.io/)
- [MongoDB Go Driver](https://www.mongodb.com/docs/drivers/go/current/)
- [Redis Go Client](https://redis.uptrace.dev/)

---

**更新时间**: 2025-11-25  
**维护者**: lianghaolin
