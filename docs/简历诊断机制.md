# 简历诊断机制

## 概述

简历诊断是一项付费功能，对用户简历进行全面分析，生成包含**人岗匹配分析**、**就业分析**、**分项评估报告**和**整体评价**的诊断报告。

---

## 核心组件

| 层级 | 文件 | 说明 |
|------|------|------|
| Domain | `domain/diagnosis.go` | 定义实体、BO、接口 |
| Usecase | `usecase/diagnosis_usecase.go` | 诊断核心业务逻辑 |
| Repo | `repo/diagnosis_repo.go` | 数据持久化 |
| Controller | `api/controller/diagnosis_controller.go` | HTTP 接口 |
| Route | `api/route/diagnosis_route.go` | 路由注册 |

---

## 数据模型

### 诊断主表 `rm_diagnosis_main`

| 字段 | 类型 | 说明 |
|------|------|------|
| `diagnosis_record_id` | bigint | 诊断记录ID（主键） |
| `user_id` | bigint | 用户ID |
| `tenant_id` | varchar | 租户ID |
| `outTradeNo` | varchar | 订单号（唯一） |
| `name` | varchar | 简历姓名 |
| `resume_snapshot_json` | longtext | 简历结构化快照 |
| `resume_snapshot_md` | longtext | 简历 Markdown 快照 |
| `job_match_analysis` | text | 人岗匹配分析结果 |
| `employment_analysis` | text | 就业分析结果 |
| `overall_evaluation` | text | 整体评价 |
| `diagnosis_score` | decimal | 诊断总分（百分制） |
| `diagnosis_status` | tinyint | 状态：1进行中/2完成/3失败/4取消 |

### 诊断报告表 `rm_diagnosis_report`

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | bigint | 主键 |
| `diagnosis_record_id` | bigint | 关联诊断ID |
| `dimension` | varchar | 模块名称（如：基本信息、教育背景） |
| `score` | double | 模块分数 |
| `advantages` | text | 优点 |
| `shortcomings` | text | 缺点/不足 |
| `evaluation` | text | 单项总评 |
| `suggestion` | text | 优化方案 |

---

## 诊断状态

```go
// internal/consts/const.go
const (
    DiagnosisStatusProcessing = 1  // 进行中
    DiagnosisStatusCompleted  = 2  // 已完成
    DiagnosisStatusFailed     = 3  // 失败
    DiagnosisStatusCanceled   = 4  // 已取消
)
```

---

## API 接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/diagnosis/list` | 获取诊断记录列表 |
| POST | `/diagnosis/upload` | 上传简历文件创建诊断 |
| POST | `/diagnosis/start` | 启动诊断（需订单号） |
| POST | `/diagnosis/start-by-resume` | 基于已有简历启动诊断 |
| GET | `/diagnosis/result/:id` | 获取诊断结果 |

---

## 核心流程

### 1. 启动诊断 (Start/StartByResume)

```
用户请求 → 订单校验 → 创建诊断记录 → 异步执行诊断任务
```

**关键步骤**:
1. 校验订单支付状态（调用时机服务 `/api/resume/diagnosis/verify`）
2. 检查订单是否已使用（唯一约束）
3. 更新状态为 `Processing`
4. 启动后台 goroutine 执行诊断

### 2. 诊断执行流程 (runDiagnosis)

```
┌─────────────────────────────────────────────────────────────┐
│                      runDiagnosis                           │
├─────────────────────────────────────────────────────────────┤
│  1. 获取简历 Markdown                                        │
│  2. 提取意向岗位 (extractJobIntention)                       │
│                                                             │
│  ┌─────────────────┐     ┌─────────────────────────────┐   │
│  │   并行任务 A     │     │        并行任务 B            │   │
│  │                 │     │                             │   │
│  │ • 岗位推荐      │     │ • 确保结构化数据             │   │
│  │ • 人岗匹配任务  │     │ • 构建分项报告               │   │
│  │ • 就业分析任务  │     │ • 计算诊断总分               │   │
│  │                 │     │ • 生成整体评价               │   │
│  └─────────────────┘     └─────────────────────────────┘   │
│                                                             │
│  3. 等待所有任务完成                                         │
│  4. 更新诊断结果到数据库                                     │
└─────────────────────────────────────────────────────────────┘
```

### 3. 分项报告生成 (buildDiagnosisReports)

针对每个简历模块（基本信息、教育背景、技能证书等）：

1. **加载模块元数据**: 从 `section_code` 和 `rule_score` 表获取评分规则
2. **计算模块分数**: 调用算法服务 `algCli.Score()` 进行评分
3. **创建分项报告任务**: 调用算法服务生成优缺点、优化方案
4. **轮询任务结果**: 等待算法服务返回
5. **解析并存储**: 将结果写入 `rm_diagnosis_report` 表

### 4. 诊断总分计算

```go
// usecase/diagnosis_usecase.go:953-970
func calcDiagnosisScore(reports []*domain.DiagnosisReportBO) (float64, error) {
    sum := 0.0
    count := 0
    for _, r := range reports {
        sum += *r.Score
        count++
    }
    return roundScore(sum / float64(count)), nil  // 各模块分数平均值
}
```

---

## 外部服务依赖

### 1. 算法服务

| 功能 | 接口 |
|------|------|
| 结构化转换 | `algCli.Markdown2Struct()` |
| 模块评分 | `algCli.Score()` |
| 岗位推荐 | `matchJobs()` |
| 人岗匹配任务 | `/writer/resume_master_job_match_report_task` |
| 就业分析任务 | `/writer/resume_master_job_analyse_report_task` |
| 分项报告任务 | `/writer/resume_master_part_eval_report_task` |
| 整体评价任务 | `/writer/report_gen_task` |

### 2. 时机服务

- 订单支付校验: `GET /api/resume/diagnosis/verify`

---

## 诊断结果视图

```go
// domain/diagnosis.go:232-244
type DiagnosisResultView struct {
    DiagnosisStatus *int                // 诊断状态
    ResumeMD        *string             // 简历 Markdown 原文
    ResumeSections  []ResumeSectionData // 按模块拆分的结构化数据
    Summary         struct {
        Score              *float64         // 诊断总分
        OverallEvaluation  *string          // 整体评价
        SectionEvaluations []SectionSummary // 各模块分数与评价
    }
    JobMatch   []DiagnosisPart    // 人岗匹配分析
    PartView   []ModuleReportView // 分项视图（含优缺点、优化方案）
    Employment EmploymentView     // 就业分析
}
```

---

## 统计功能

### 诊断统计接口

```
POST /api/v1/resume/diagnosis-statistics
```

**请求**:
```json
{
    "userIds": ["123", "456"],
    "beginTime": "2024-01-01 00:00:00",
    "endTime": "2024-12-31 23:59:59"
}
```

**响应**:
```json
{
    "submitted": 10,       // 已提交诊断的学生数
    "excellentCount": 3,   // 优秀人数 (80-100分)
    "goodCount": 5,        // 良好人数 (60-79分)
    "poorCount": 2,        // 较差人数 (<60分)
    "averageScore": 72.5   // 平均分
}
```

---

## 错误处理

| 场景 | 处理方式 |
|------|----------|
| 订单未支付 | 返回 409 Conflict |
| 订单已使用 | 返回 409 Conflict |
| 诊断任务超时 | 5分钟超时，标记失败 |
| 算法服务异常 | 标记诊断失败 |

---

## 关键代码位置

- 诊断 Usecase: `usecase/diagnosis_usecase.go:1-1673`
- 启动诊断: `usecase/diagnosis_usecase.go:271-332`
- 执行诊断: `usecase/diagnosis_usecase.go:334-459`
- 分项报告: `usecase/diagnosis_usecase.go:691-814`
- 总分计算: `usecase/diagnosis_usecase.go:953-970`
- 整体评价: `usecase/diagnosis_usecase.go:979-1033`
- 数据模型: `domain/diagnosis.go:10-286`
- 数据访问: `repo/diagnosis_repo.go:15-277`
